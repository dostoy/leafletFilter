var startDate = new Date();
startDate.setUTCHours(0, 0, 0, 0);

// Defining the map type and its time atributes -- note that for operational use, we have to deal with this

var map = L.map('map', {
    zoom: 5,
    fullscreenControl: true,
        timeDimension: true,
     timeDimensionOptions:{
        timeInterval: "2016-05-19T12:05:04.000Z/2016-05-23T00:05:04.000Z",
        period: "PT12H"
    },
    timeDimensionControl: true,

   center: [40.0, -4.50],
});


// We construct the base layer of the map with OSM

var openstreetmap = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
        maxZoom: 18})


// If we like, we could change the OSM tile to satellite imagery
        var esrimap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Map data &copy; <a href="http://www.esri.com/">Esri</a>, contributors, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 18})

// we load each layer of a ROMS file served by GMO THREDDS server. Note: we are @ 3 km resolution!

var tempLayer = L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_3km/roms_cf_D0_16051806.nc", {
    layers: 'temp',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    numcolorbands: 36,
    styles: 'boxfill/sst36',
	version: '1.3.0'
});

var currentLayer = L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_3km/roms_cf_D0_16051218.nc", {
    layers: 'baroclinic_sea_water_velocity',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    colorscalerange: '1,1',
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    markerscale: 10,
    markerspacing: 10,
    markerclipping: true,
    styles: 'linevec/greyscale',
	version: '1.3.0'
});

var saltLayer=L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_3km/roms_cf_D0_16051218.nc", {
	layers: 'salt',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    numcolorbands:36,
    styles: 'boxfil/sst_36',
	version: '1.3.0'
});

var tempTimeLayer = L.timeDimension.layer.wms(tempLayer);
//tempTimeLayer.addTo(map);

//a pretty legend for the temp layer
uri = "http://gmo.web.ua.pt/thredds/wms/LD/2016/D_3km/roms_cf_D0_16051218.nc?REQUEST=GetLegendGraphic&LAYER=temp&numcolorbands=36&PALETTE=sst_36&transparent=TRUE";
// L.wmsLegend(uri,'legend');

var currentTimeLayer = L.timeDimension.layer.wms(currentLayer);



var saltTimeLayer=L.timeDimension.layer.wms(saltLayer);
//saltTimeLayer.addTo(map);



// Let's get a timeseries of sea water potential temperature
var proxy = 'server/proxy.php';
var tempTimeLayer = L.timeDimension.layer.wms.timeseries(tempLayer, {
    updateTimeDimension: true,
    proxy: proxy,
    name: "Sea Water Potential Temperature",
    units: "ºC",
    enableNewMarkers: true,
    version: '1.3.0'
});


// Now, the ROMS output @ 1 km

var tempLayer1km = L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_1km/roms_cf_D1_16051218.nc", {
    layers: 'temp',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    numcolorbands: 36,
    styles: 'boxfill/sst_36',
	version: '1.3.0'
});

var currentLayer1km = L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_1km/roms_cf_D1_16050306.nc", {
    layers: 'baroclinic_sea_water_velocity',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    colorscalerange: '1,1',
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    markerscale: 10,
    markerspacing: 10,
    markerclipping: true,
    styles: 'linevec/greyscale',
	version: '1.3.0'
});

var saltLayer1km=L.tileLayer.wms("http://gmo.web.ua.pt/thredds/wms/LD/2016/D_1km/roms_cf_D1_16050306.nc", {
	layers: 'salt',
    format: 'image/png',
    transparent: true,
    opacity:0.8,
    abovemaxcolor: "extend",
    belowmincolor: "extend",
    numcolorbands:30,
    styles: 'boxfil/sst',
	version: '1.3.0'
});

var tempTimeLayer1km = L.timeDimension.layer.wms(tempLayer1km);
//tempTimeLayer.addTo(map);

//a pretty legend for the temp layer
//uri2 = "http://gmo.web.ua.pt/thredds/wms/LD/2016/D_1km/roms_cf_D1_16050306.nc?REQUEST=GetLegendGraphic&LAYER=temp&colorscalerange=12,24&numcolorbands=12&PALETTE=sst&transparent=TRUE";
//L.wmsLegend(uri2,'legend');

var currentTimeLayer1km = L.timeDimension.layer.wms(currentLayer1km);



var saltTimeLayer1km=L.timeDimension.layer.wms(saltLayer1km);
//saltTimeLayer.addTo(map);




var tempTimeLayer1km = L.timeDimension.layer.wms.timeseries(tempLayer1km, {
    updateTimeDimension: false,
    name: "Sea Water Potential Temperature",
    units: "ºC",
    enableNewMarkers: true,
    version: '1.3.0'
});








var baseMaps = {
          "OpenStreetMap": openstreetmap,
          "Esri Map":esrimap,
      };
      var overlayMaps = {
          "ROMS @ 3 km - Sea Water Potential Temperature": tempTimeLayer,
          "ROMS @ 3 km - Baroclinic Sea Water Velocity": currentTimeLayer,
          "ROMS @ 3 km - Salinity": saltTimeLayer,
          "ROMS @ 1 km - Sea Water Potential Temperature": tempTimeLayer1km,
          "ROMS @ 1 km - Baroclinic Sea Water Velocity": currentTimeLayer1km,
          "ROMS @ 1 km - Salinity": saltTimeLayer1km,
      };
      openstreetmap.addTo(map);
      tempTimeLayer.addTo(map);
      L.control.layers(baseMaps, overlayMaps).addTo(map);





L.control.coordinates({
    position: "bottomright",
    decimals: 3,
    labelTemplateLat: "Latitude: {y}",
    labelTemplateLng: "Longitude: {x}",
    useDMS: true,
    enableUserInput: false
}).addTo(map);
